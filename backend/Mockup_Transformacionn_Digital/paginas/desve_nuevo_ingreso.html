<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Atención</title>
    <link href="../recursos/css/bootstrap.min.css" rel="stylesheet">
    <link href="../recursos/css/style.css" rel="stylesheet">
    <link rel="icon" href="data:,">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-title h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.25rem;
        }

        .header-title p {
            color: #6c757d;
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        .btn-toolbar {
            background-color: white;
            border: 1px solid #dee2e6;
            color: #212529;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-toolbar:hover {
            background-color: #f8f9fa;
            border-color: #cdd4da;
        }

        .btn-toolbar i {
            font-size: 1rem;
        }

        .btn-dark-custom {
            background-color: #000;
            color: white;
            border: 1px solid #000;
        }

        .btn-dark-custom:hover {
            background-color: #333;
            color: white;
        }

        .card-custom {
            background: white;
            border-radius: 8px;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 24px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 0.25rem;
        }

        .section-subtitle {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 24px;
        }

        .form-label {
            font-weight: 500;
            font-size: 0.85rem;
            color: #495057;
            margin-bottom: 6px;
        }

        .form-control,
        .form-select {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
            padding: 0.6rem 0.75rem;
        }

        .form-control::placeholder {
            color: #adb5bd;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: white;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .solo_consulta {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <!-- Header & Toolbar -->
        <div class="main-header">
            <div class="header-title">
                <h2>Consulta de Atención</h2>
                <p>Consulta y gestiona información de atenciones individuales</p>
            </div>
            <div class="toolbar">
                <button class="btn btn-toolbar d-none" id="btn_ingreso_original">
                    <i data-feather="arrow-left-circle"></i> Ingreso Original
                </button>
                <button class="btn btn-toolbar" onclick="buscarAtencion()">
                    <i data-feather="search"></i> Buscar
                </button>
                <button class="btn btn-toolbar" onclick="nuevaAtencion()">
                    <i data-feather="plus"></i> Nueva
                </button>
                <button class="btn btn-toolbar" onclick="modificarAtencion()">
                    <i data-feather="edit"></i> Modificar
                </button>
                <button class="btn btn-toolbar" id="btn_ingresar_respuesta">
                    <i data-feather="message-circle"></i> Ingresar Respuesta
                </button>
                <!-- <button class="btn btn-toolbar text-danger" onclick="eliminarAtencion()">
                    <i data-feather="trash-2"></i> Eliminar
                </button> -->
                <button class="btn btn-toolbar btn-dark-custom" onclick="guardarAtencion()">
                    <i data-feather="save"></i> Guardar
                </button>
            </div>
        </div>

        <!-- Información del Ingreso -->
        <div class="card-custom">
            <h3 class="section-title">Información del Ingreso</h3>
            <p class="section-subtitle">Datos generales del ingreso realizado</p>

            <form id="formConsultaAtencion">
                <!-- Row 1 -->

                <div class="row g-4 mb-3">
                    <div class="col-md-4 solo_consulta">
                        <label for="idIngreso" class="form-label">ID Ingreso</label>
                        <input type="text" class="form-control" id="idIngreso" placeholder="" disabled>
                    </div>
                    <div class="col-md-4">
                        <label for="IngresoDesve" class="form-label">Ingreso Desve</label>
                        <input type="text" class="form-control" id="IngresoDesve" placeholder="ABC-123456" disabled>
                    </div>
                    <div class="col-md-4">
                        <label for="Reingresado" class="form-label">Reingresado</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="Reingresado" placeholder="" disabled hidden>
                            <input type="text" class="form-control" id="ReingresadoNombre"
                                placeholder="Seleccione ingreso previo ..." readonly disabled>
                            <button class="btn btn-outline-secondary" type="button" id="btn_buscar_reingresado"
                                onclick="abrirModalReingresado()" disabled>
                                <i data-feather="search" style="width: 16px;"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row g-4 mb-3">
                    <div class="col-md-4">
                        <label for="NombreExpediente" class="form-label">Nombre del expediente</label>
                        <input type="text" class="form-control" id="NombreExpediente"
                            placeholder="Consula por Luminaria" disabled>
                    </div>
                    <div class="col-md-4 ">
                        <label for="ID_Organizacion" class="form-label">Tipo de organización</label>
                        <select class="form-select" id="ID_Organizacion" disabled>
                            <option value="">Seleccione tipo de organización...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="OrigenSolicitud" class="form-label">Origen de solicitud</label>
                        <div class="input-group">
                            <select class="form-select" id="OrigenSolicitud" disabled>
                                <option value="">Seleccione organización...</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" id="btn_nuevo_origen"
                                onclick="abrirModalOrigenEspecial()" disabled>
                                <i data-feather="plus" style="width: 16px;"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row g-4 mb-3">
                        <div class="col-md-4">
                            <label for="FechaUltimaRecepcion" class="form-label">Fecha recepción</label>
                            <input type="date" class="form-control" id="FechaUltimaRecepcion" placeholder="" disabled>
                        </div>
                        <div class="col-md-4 solo_consulta">
                            <label for="FechaCreacion" class="form-label">Fecha de Creación</label>
                            <input type="date" class="form-control" id="FechaCreacion" readonly disabled>
                        </div>
                        <div class="col-md-4 solo_consulta">
                            <label for="Prioridad" class="form-label">Prioridad</label>
                            <input type="text" class="form-control" id="Prioridad" placeholder="" readonly disabled>
                        </div>
                    </div>
                    <div class="row g-4 mb-3">
                        <div class="col-md-4">
                            <label for="FuncionarioInternoNombre" class="form-label">Funcionario Interno</label>
                            <div class="input-group">
                                <input type="hidden" id="FuncionarioInternoId">
                                <input type="text" class="form-control" id="FuncionarioInternoNombre"
                                    placeholder="Seleccione funcionario..." readonly disabled>
                                <button class="btn btn-outline-secondary" type="button" id="btn_buscar_funcionario"
                                    onclick="abrirModalFuncionarios()" disabled>
                                    <i data-feather="search" style="width: 16px;"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="Sector" class="form-label">Sector</label>
                            <select class="form-select" id="Sector" disabled>
                                <!-- Populated from sectores.json -->
                            </select>
                        </div>
                        <div class="col-md-4 solo_consulta">
                            <label for="MailEnviadoFecha" class="form-label">Fecha del último Email enviado</label>
                            <input type="date" class="form-control" id="MailEnviadoFecha" placeholder="" disabled>
                        </div>
                        <div class="col-md-4 solo_consulta">
                            <label for="NumeroMailEnviado" class="form-label">Número de Mails enviados</label>
                            <input type="number" class="form-control" id="NumeroMailEnviado" placeholder="" readonly
                                disabled>
                        </div>
                    </div>
                    <div class="row g-4 mb-3">
                        <div class="col-md-4">
                            <label for="FechaVecimiento" class="form-label">Fecha Vencimiento</label>
                            <input type="date" class="form-control" id="FechaVecimiento" placeholder="" disabled>
                        </div>
                    </div>
                    <div class="row g-4 mb-3">
                        <div class="col-md-4 solo_consulta">
                            <label for="EntregadoEnConformidad" class="form-label">Entregado en conformidad</label>
                            <input type="text" class="form-control" id="EntregadoEnConformidad" placeholder="" readonly
                                disabled>
                        </div>
                        <div class="col-md-4 solo_consulta">
                            <label for="FechaRespuesta" class="form-label">Fecha respuesta</label>
                            <input type="date" class="form-control" id="FechaRespuesta" placeholder="" disabled>
                        </div>
                        <div class="col-md-4 solo_consulta">
                            <label class="form-label d-block">Estado de entrega</label>
                            <div class="btn-group w-100" role="group" aria-label="Estado de entrega">
                                <input type="radio" class="btn-check" name="EstadoEntrega" id="estadoPendiente"
                                    value="0" checked>
                                <label class="btn btn-outline-warning" for="estadoPendiente">Pendiente</label>

                                <input type="radio" class="btn-check" name="EstadoEntrega" id="estadoRespondido"
                                    value="1">
                                <label class="btn btn-outline-success" for="estadoRespondido">Respondido</label>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4 mb-3">
                        <div class="col-md-4 solo_consulta">
                            <label for="DiasIngreso" class="form-label">Días transcurridos (Ingreso)</label>
                            <input type="number" class="form-control" id="DiasIngreso" readonly>
                        </div>
                        <div class="col-md-4 solo_consulta">
                            <label for="DiasVencimiento" class="form-label">Días restantes para vencimiento</label>
                            <input type="number" class="form-control" id="DiasVencimiento" readonly>
                        </div>
                    </div>
                    <!-- New Row for Meta Info -->
                    <div class="row g-4 mb-3">
                        <div class="col-md-12 solo_consulta">
                            <label for="Responsable" class="form-label">Responsable (Creador)</label>
                            <input type="text" class="form-control" id="Responsable"
                                placeholder="Nombre del responsable" readonly disabled>
                        </div>
                    </div>
                    <div class="row g-4 mb-3">
                        <div class="col-md-12">
                            <label for="DetalleIngreso" class="form-label">Detalle de ingreso</label>
                            <textarea class="form-control" id="DetalleIngreso" rows="4" disabled></textarea>
                        </div>
                    </div>
                    <div class="row g-4 mb-3">
                        <div class="col-md-12">
                            <label for="Observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="Observaciones" rows="3" disabled></textarea>
                        </div>
                    </div>
                    <!-- Documentos Adjuntos -->
                    <div class="row g-4 mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Documentos Adjuntos</label>
                            <input type="file" class="form-control mb-2" id="inputArchivosSolicitud" multiple
                                onchange="handleFileSelect('solicitud')">
                            <div id="listaArchivosSolicitud" class="list-group">
                                <!-- File list populated by JS -->
                            </div>
                        </div>
                    </div>
            </form>

            <button class="btn btn-toolbar btn-dark-custom" onclick="guardarAtencion()">
                <i data-feather="save"></i> Guardar
            </button>
        </div>

        <!-- Bitácora de Respuestas -->
        <div class="card-custom mt-4 solo_consulta">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="section-title mb-0">Bitácora de Respuestas</h3>
                <button class="btn btn-sm btn-link text-dark p-0" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseBitacoraRespuestas">
                    <i data-feather="chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="collapseBitacoraRespuestas">
                <p class="section-subtitle mt-2">Respuestas entregadas a esta solicitud</p>
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="tablaBitacora">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Funcionario</th>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Respuesta / Comentario</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reingresos Vinculados -->
        <div class="card-custom mt-4 solo_consulta">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="section-title mb-0">Reingresos Vinculados</h3>
                <button class="btn btn-sm btn-link text-dark p-0" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseReingresos">
                    <i data-feather="chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="collapseReingresos">
                <p class="section-subtitle mt-2">Otros ingresos que derivan de esta solicitud</p>
                <div class="table-responsive">
                    <table class="table table-sm table-hover" id="tablaReingresos">
                        <thead class="table-light">
                            <tr>
                                <th>ID Solicitud</th>
                                <th>Nombre Expediente</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bitácora de Auditoría -->
        <div class="card-custom mt-4 solo_consulta">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="section-title mb-0">Bitácora de Auditoría</h3>
                <!--<button class="btn btn-toolbar" onclick="cargarBitacora()">
                    <i data-feather="search"></i> Cargar Bitacora
                </button>-->
                <button class="btn btn-sm btn-link text-dark p-0" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseAuditoria">
                    <i data-feather="chevron-down"></i>
                </button>
            </div>
            <div class="collapse" id="collapseAuditoria">
                <p class="section-subtitle mt-2">Historial de acciones y eventos del trámite</p>
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Quien</th>
                                <th>Que</th>
                            </tr>
                        </thead>
                        <tbody id="bitacora-body">
                            <!-- Bitacora entries will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Comentarios / Observaciones -->
        <div class="card-custom mt-4 mb-5 solo_consulta">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <h3 class="section-title mb-0">Comentarios / Observaciones</h3>
                    <button class="btn btn-sm btn-link text-dark p-0" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseComentarios">
                        <i data-feather="chevron-down"></i>
                    </button>
                </div>
                <button class="btn btn-sm btn-dark-custom" id="btn_abrir_comentario">
                    <i data-feather="message-square" style="width: 14px;"></i> Agregar Comentario
                </button>
            </div>
            <div class="collapse show" id="collapseComentarios">
                <div id="comentarios-container">
                    <div class="alert alert-info py-2 small mt-3">
                        <i data-feather="info" class="me-2" style="width: 14px;"></i>
                        Cargando comentarios...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Reingresados -->
    <div class="modal fade" id="modalReingresados" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mantenedor de Reingresados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex gap-2">
                        <input type="text" class="form-control" id="filtroReingresados"
                            placeholder="Filtrar por nombre de expediente o ID ...">
                    </div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover" id="tablaReingresados">
                            <thead class="table-light">
                                <tr>
                                    <th>ID Solicitud</th>
                                    <th>Nombre Expediente</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Funcionarios -->
    <div class="modal fade" id="modalFuncionarios" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mantenedor de Funcionarios</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex gap-2">
                        <input type="text" class="form-control" id="filtroFuncionario"
                            placeholder="Filtrar por nombre o RUT...">
                    </div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover" id="tablaFuncionarios">
                            <thead class="table-light">
                                <tr>
                                    <th>RUT</th>
                                    <th>Nombre</th>
                                    <th>Cargo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ingresar Respuesta -->
    <div class="modal fade" id="modalRespuesta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ingresar Nueva Respuesta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevaRespuesta">
                        <div class="mb-3">
                            <label for="inputTipoRespuesta" class="form-label">Tipo de Acción</label>
                            <select class="form-select" id="inputTipoRespuesta">
                                <option value="Comentario" selected>Comentario</option>
                                <option value="Respuesta Final">Respuesta Final</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="textoRespuesta" class="form-label">Respuesta / Comentario</label>
                            <textarea class="form-control" id="textoRespuesta" rows="4"
                                placeholder="Escriba la respuesta aquí..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Adjuntar Archivos</label>
                            <input type="file" class="form-control mb-2" id="inputArchivosRespuesta" multiple
                                onchange="handleFileSelect('respuesta')">
                            <div id="listaArchivosRespuesta" class="list-group">
                                <!-- File list populated by JS -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-dark-custom" onclick="enviarRespuesta()">Enviar
                        Respuesta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Comentario -->
    <div class="modal fade" id="modalNuevoComentario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Comentario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="textoNuevoComentario" class="form-label small fw-bold">Su Comentario</label>
                        <textarea class="form-control" id="textoNuevoComentario" rows="4"
                            placeholder="Escriba aquí su comentario u observación..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-dark-custom" onclick="guardarComentario()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Origen Especial -->
    <div class="modal fade" id="modalNuevoOrigenEspecial" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Origen Especial</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="textoNuevoOrigenEspecial" class="form-label small fw-bold">Nuevo Origen
                            Especial</label>
                        <input type="text" class="form-control" id="textoNuevoOrigenEspecial"
                            placeholder="Escriba aquí el origen especial...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-dark-custom" onclick="guardarOrigenEspecial()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <button class="btn btn-dark rounded-circle position-fixed bottom-0 end-0 m-4" style="width: 50px; height: 50px;">
        <i data-feather="help-circle"></i>
    </button>

    <script src="../recursos/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        feather.replace();
    </script>
    <script src='../recursos/js/layout_manager.js'></script>
    <script src="../recursos/js/desve_nuevo_ingreso.js"></script>
</body>

</html>